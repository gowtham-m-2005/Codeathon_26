<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Container Routing Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root{--bg:#071229;--card:#0b1622;--muted:#9aa4b2;--accent:#06b6d4;--success:#10b981;--warn:#f59e0b}
        html,body{height:100%;}
        body{font-family:Inter,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#041021 0%,#071229 100%); color:#e6eef6; margin:0; padding:20px}
        .container{max-width:1200px;margin:0 auto}
        h1{margin:0 0 8px 0; font-size:24px}
        .subtitle{color:var(--muted); margin-bottom:16px}
        .grid{display:grid; grid-template-columns:1fr 380px; gap:16px; align-items:start}
        .card{background:var(--card); padding:16px; border-radius:10px; box-shadow:0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
        .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
        .status-idle{background:#374151; color:#9ca3af}
        .status-active{background:rgba(16,185,129,0.2); color:var(--success)}
        .capacity{display:flex; gap:12px; margin:12px 0}
        .capacity-item{flex:1; text-align:center; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px}
        .capacity-item .num{font-size:20px; font-weight:700; color:var(--accent)}
        .capacity-item .label{font-size:12px; color:var(--muted); margin-top:4px}
        .task-queue{margin-top:16px}
        .task-queue h3{margin:0 0 10px 0; font-size:16px}
        table{width:100%; border-collapse:collapse}
        th{text-align:left; padding:10px 8px; color:var(--muted); font-size:13px; border-bottom:1px solid rgba(255,255,255,0.06)}
        td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03)}
        .priority-num{width:50px; text-align:center; font-weight:700; color:var(--accent)}
        .task-type{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600}
        .task-pickup{background:rgba(6,182,212,0.15); color:#06b6d4}
        .task-delivery{background:rgba(124,58,237,0.15); color:#a78bfa}
        .task-status{font-size:12px}
        .task-pending{color:#9ca3af}
        .task-inprogress{color:var(--warn)}
        .task-completed{color:var(--success)}
        .btn{display:inline-block; padding:8px 14px; background:linear-gradient(90deg,var(--accent),#7c3aed); color:#042027; border-radius:8px; text-decoration:none; font-weight:700; border:none; cursor:pointer; font-size:13px}
        .btn:disabled{opacity:0.4; cursor:not-allowed}
        .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--muted)}
        .btn.small{padding:6px 10px; font-size:12px}
        .no-route{text-align:center; padding:40px; color:var(--muted)}
        .actions{display:flex; gap:8px; margin-top:12px}
        #map{height:500px; border-radius:8px; overflow:hidden; margin-top:12px; border:2px solid rgba(6,182,212,0.3)}
        .leaflet-routing-container{display:none !important;}
        .leaflet-control-container .leaflet-routing-container{display:none !important;}
        .leaflet-top.leaflet-right{display:none;}
        .route-info{background:rgba(6,182,212,0.1); padding:8px 12px; border-radius:6px; border-left:3px solid var(--accent); margin-top:8px; font-size:13px}
        @media (max-width:980px){.grid{grid-template-columns:1fr;}}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container">
        <h1>Container Routing Dashboard</h1>
        <p class="subtitle">Priority-Based Task Queue & Route Management</p>

        <div class="grid">
            <div>
                <div class="card">
                    <h2 style="margin:0 0 8px 0; font-size:18px">Container: <%= container.container_code %></h2>
                    <p style="margin:0; color:var(--muted); font-size:13px">
                        Driver: <%= container.driver_name || '‚Äî' %> | 
                        <span class="status-badge status-<%= container.status === 'ACTIVE' ? 'active' : 'idle' %>">
                            <%= container.status || 'IDLE' %>
                        </span>
                    </p>

                    <div class="capacity">
                        <div class="capacity-item">
                            <div class="num"><%= container.total_sections || 0 %></div>
                            <div class="label">Total Sections</div>
                        </div>
                        <div class="capacity-item">
                            <div class="num"><%= container.used_sections || 0 %></div>
                            <div class="label">Used</div>
                        </div>
                        <div class="capacity-item">
                            <div class="num"><%= container.available_sections || 0 %></div>
                            <div class="label">Available</div>
                        </div>
                    </div>

                    <div class="actions">
                        <% if (!route) { %>
                            <a class="btn" href="/container/<%= container.container_id %>/plan-route">Create New Route</a>
                        <% } %>
                        <a class="btn ghost" href="/container/<%= container.container_id %>">View Details</a>
                    </div>
                </div>

                <div class="card task-queue">
                    <h3>Priority Task Queue</h3>
                    <% if (route && tasks && tasks.length > 0) { %>
                        <table>
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Task</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% 
                                    // Find the first PENDING task to unlock
                                    const firstPendingIndex = tasks.findIndex(t => t.task_status === 'PENDING');
                                %>
                                <% tasks.forEach((task, index) => { %>
                                    <tr>
                                        <td class="priority-num"><%= task.priority_order %></td>
                                        <td>
                                            <span class="task-type task-<%= task.task_type.toLowerCase() %>">
                                                <%= task.task_type %>
                                            </span>
                                        </td>
                                        <td><%= task.location_name || task.node_type %></td>
                                        <td class="task-status task-<%= task.task_status.toLowerCase() %>">
                                            <%= task.task_status %>
                                        </td>
                                        <td>
                                            <% if (index === firstPendingIndex && task.task_status === 'PENDING') { %>
                                                <form method="POST" action="/task/<%= task.task_id %>/start" style="margin:0">
                                                    <button type="submit" class="btn small">GO</button>
                                                </form>
                                            <% } else if (task.task_status === 'IN_PROGRESS') { %>
                                                <a class="btn small ghost" href="/task/<%= task.task_id %>/transaction">Continue</a>
                                            <% } else if (task.task_status === 'PENDING') { %>
                                                <span style="color:var(--muted); font-size:11px">Locked</span>
                                            <% } else { %>
                                                <span style="color:var(--success); font-size:11px">‚úì</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div class="no-route">
                            <p>No active route. Create a route to start routing tasks.</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="card">
                <h3 style="margin:0 0 8px 0; font-size:16px">üó∫Ô∏è Road Route Map</h3>
                <p style="margin:0 0 8px 0; font-size:12px; color:var(--muted);">
                    Route follows actual roads using OSRM routing engine
                </p>
                <div id="routeInfo" class="route-info" style="display:none;">
                    <strong>üìç Route Details:</strong><br/>
                    <span id="routeDistance">Calculating...</span><br/>
                    <span id="routeTime">Please wait...</span>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        const container = <%- JSON.stringify(container || {}) %>;
        const tasks = <%- JSON.stringify(tasks || []) %>;

        // Initialize map
        const map = L.map('map', {zoomControl:true});
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

        // Plot container location
        const cLat = parseFloat(container.current_latitude);
        const cLng = parseFloat(container.current_longitude);
        let validContainer = false;
        
        if (!isNaN(cLat) && !isNaN(cLng)) {
            validContainer = true;
            const containerMarker = L.marker([cLat, cLng], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background:#06b6d4; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            containerMarker.bindPopup(`<strong>Container: ${container.container_code}</strong><br/>Current Location`);
            map.setView([cLat, cLng], 10);
        } else {
            map.setView([20.5937, 78.9629], 5);
        }

        // Build route waypoints in priority order
        const allTasks = [...tasks]; // Include all tasks (completed, pending, in-progress)
        const waypoints = [];
        const markers = [];
        
        // Start from container location if valid
        if (validContainer) {
            waypoints.push(L.latLng(cLat, cLng));
        }
        
        // Add task locations in priority order
        allTasks.forEach((task, i) => {
            const lat = parseFloat(task.latitude);
            const lng = parseFloat(task.longitude);
            if (!isNaN(lat) && !isNaN(lng)) {
                waypoints.push(L.latLng(lat, lng));
                
                // Create numbered markers for tasks
                const isCompleted = task.task_status === 'COMPLETED';
                const isPending = task.task_status === 'PENDING';
                const isPickup = task.task_type === 'PICKUP';
                const color = isPickup ? '#10b981' : '#7c3aed';
                const bgColor = isCompleted ? '#9ca3af' : (isPending ? color : '#f59e0b');
                
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background:${bgColor}; color:white; width:28px; height:28px; border-radius:50%; border:3px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px;">${task.priority_order}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${task.task_type}</strong><br/>
                    Priority: ${task.priority_order}<br/>
                    Status: ${task.task_status}<br/>
                    ${task.location_name || task.node_type}
                `);
                
                markers.push(marker);
            }
        });

        // Draw route if we have waypoints
        if (waypoints.length >= 2) {
            console.log('Creating road route with waypoints:', waypoints.length);
            waypoints.forEach((wp, i) => console.log(`Waypoint ${i}:`, wp.lat, wp.lng));
            
            try {
                const routingControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [{
                            color: '#8B0000',
                            opacity: 0.9,
                            weight: 6
                        }],
                        extendToWaypoints: true,
                        missingRouteTolerance: 100
                    },
                    router: new L.Routing.OSRMv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'car',
                        timeout: 30000,
                        useHints: false
                    }),
                    createMarker: function() { return null; },
                    show: false,
                    collapsible: false,
                    plan: L.Routing.plan(waypoints, {
                        createMarker: function() { return null; },
                        addWaypoints: false,
                        draggableWaypoints: false
                    })
                }).addTo(map);
                
                // Hide the routing instructions panel and show route details
                routingControl.on('routesfound', function(e) {
                    const route = e.routes[0];
                    const distanceKm = (route.summary.totalDistance / 1000).toFixed(2);
                    const timeHours = (route.summary.totalTime / 3600).toFixed(1);
                    
                    console.log(`‚úÖ Road route found: ${distanceKm} km, ~${timeHours} hours`);
                    
                    // Show route info
                    document.getElementById('routeInfo').style.display = 'block';
                    document.getElementById('routeDistance').textContent = `Distance: ${distanceKm} km via roads`;
                    document.getElementById('routeTime').textContent = `Estimated Time: ${timeHours} hours`;
                    
                    // Hide routing control panel
                    const container = document.querySelector('.leaflet-routing-container');
                    if (container) container.style.display = 'none';
                });
                
                routingControl.on('routingerror', function(e) {
                    console.error('‚ö†Ô∏è OSRM Routing error:', e);
                    console.log('Error details:', e.error);
                    console.log('Drawing fallback polyline route...');
                    
                    // Remove failed routing control
                    try {
                        map.removeControl(routingControl);
                    } catch(err) {
                        console.log('Could not remove control:', err);
                    }
                    
                    // Draw simple polyline as fallback
                    const polyline = L.polyline(waypoints, {
                        color: '#8B0000',
                        weight: 6,
                        opacity: 0.9,
                        dashArray: '10, 10'
                    }).addTo(map);
                    
                    // Calculate straight-line distance
                    let totalDistance = 0;
                    for (let i = 0; i < waypoints.length - 1; i++) {
                        totalDistance += waypoints[i].distanceTo(waypoints[i + 1]);
                    }
                    const distanceKm = (totalDistance / 1000).toFixed(2);
                    
                    // Show route info
                    document.getElementById('routeInfo').style.display = 'block';
                    document.getElementById('routeDistance').textContent = `Distance: ~${distanceKm} km (direct line)`;
                    document.getElementById('routeTime').textContent = `Road routing unavailable - showing direct path`;
                });
                
                // Add timeout fallback
                setTimeout(function() {
                    if (document.getElementById('routeInfo').style.display === 'none') {
                        console.log('‚è±Ô∏è Routing timeout - drawing direct route');
                        routingControl.fire('routingerror', {error: {message: 'Timeout'}});
                    }
                }, 15000);
                
            } catch (error) {
                console.error('Failed to initialize routing:', error);
                
                // Draw fallback route immediately on error
                const polyline = L.polyline(waypoints, {
                    color: '#8B0000',
                    weight: 6,
                    opacity: 0.9,
                    dashArray: '10, 10'
                }).addTo(map);
                
                document.getElementById('routeInfo').style.display = 'block';
                document.getElementById('routeDistance').textContent = `Route visualization only`;
                document.getElementById('routeTime').textContent = `Direct path shown`;
            }
            
            // Fit bounds to show all waypoints
            setTimeout(() => {
                const group = L.featureGroup(markers);
                if (validContainer) {
                    group.addLayer(L.marker([cLat, cLng]));
                }
                if (group.getLayers().length > 0) {
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }, 2000);
        } else if (markers.length > 0) {
            // Fit bounds to markers if no route
            const group = L.featureGroup(markers);
            if (validContainer) {
                group.addLayer(L.marker([cLat, cLng]));
            }
            map.fitBounds(group.getBounds().pad(0.2));
        }

        // GSAP animations
        gsap.from('.card', {autoAlpha:0, y:12, stagger:0.08, duration:0.6, ease:'power3.out'});
        gsap.from('tbody tr', {autoAlpha:0, x:-8, stagger:0.04, duration:0.4, delay:0.2});

        map.whenReady(()=> setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 400));
    </script>
</body>
</html>
