<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory â€” <%= producer.producer_name %></title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        :root{ --bg:#071026; --muted:#9fb2d9 }
        body{ margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:linear-gradient(180deg,#041026,#071028); color:#e8f3ff }
        .wrap{ max-width:1200px; margin:34px auto; padding:20px }
        .header{ display:flex; align-items:center; gap:16px }
        .title{ font-size:26px; font-weight:800 }
        .sub{ color:var(--muted); font-size:13px }

        .grid{ display:grid; grid-template-columns: 420px 1fr; gap:20px; margin-top:18px }
        .panel{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.04) }

        label{ display:block; margin-bottom:6px; font-weight:700 }
        input[type=text], input[type=number] { width:100%; padding:10px 12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.05); color:inherit; margin-bottom:12px }
        button.primary{ padding:10px 14px; background:linear-gradient(90deg,#06b6d4,#3b82f6); color:white; border:none; border-radius:10px; cursor:pointer }

        #destinationMap{ height:320px; border-radius:10px; }

        .list { display:flex; flex-direction:column; gap:12px; max-height:74vh; overflow:auto; padding-right:8px }
        .item { display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); cursor:pointer }
        .item .info{ flex:1 }
        .badge{ padding:6px 10px; border-radius:8px; font-weight:700 }
        .avail{ background:linear-gradient(90deg,#10b981,#34d399); color:#022c1f }
        .out{ background:linear-gradient(90deg,#ef4444,#f97316); color:#2b0300 }

        @media (max-width:980px){ .grid{ grid-template-columns: 1fr } #destinationMap{ height:260px } }
        @media (prefers-reduced-motion: reduce){ *{ transition:none!important; animation:none!important } }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="wrap">
        <div class="header">
            <div>
                <div class="title">Inventory â€” <%= producer.producer_name %></div>
                <div class="sub">Producer location: Lat: <%= producer.inventory_latitude %>, Lng: <%= producer.inventory_longitude %></div>
            </div>
            <div style="margin-left:auto">
                <a href="/allProducers" class="sub">Back to producers</a>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <form action="/producer/<%= producer.producer_id %>/inventory" method="POST" id="addItemForm">
                    <label for="item_name">Item name</label>
                    <input id="item_name" type="text" name="item_name" required placeholder="e.g., Organic Mangoes">

                    <label for="available_quantity">Available quantity</label>
                    <input id="available_quantity" type="number" name="available_quantity" min="0" value="0" required>

                    <label for="max_delivery_time">Max Delivery Time</label>
                    <input id="max_delivery_time" type="datetime-local" name="max_delivery_time" required>

                    <input type="hidden" name="inventory_latitude" value="<%= producer.inventory_latitude %>">
                    <input type="hidden" name="inventory_longitude" value="<%= producer.inventory_longitude %>">
                    <input type="hidden" name="destination_latitude" id="destination_lat" value="<%= producer.inventory_latitude %>">
                    <input type="hidden" name="destination_longitude" id="destination_lng" value="<%= producer.inventory_longitude %>">

                    <button type="submit" class="primary">Add to Inventory</button>
                </form>

                <hr style="margin:16px 0; border:none; border-top:1px solid rgba(255,255,255,0.03)">

                <div class="sub" style="margin-bottom:10px">Select Destination (click on map)</div>
                <div id="destinationMap"></div>
            </div>

            <div class="panel">
                <% if (!inventory || inventory.length === 0) { %>
                    <div class="sub">No inventory items found for this producer.</div>
                <% } else { %>
                    <div class="list" id="inventoryList">
                        <% inventory.forEach(function(item, idx){ %>
                            <div class="item" data-idx="<%= idx %>">
                                <div class="info">
                                    <div style="font-weight:800"><%= item.item_name %> <span style="color:var(--muted); font-weight:600">â€¢ x<%= item.available_quantity %></span></div>
                                    <div class="sub">Origin: <%= item.inventory_latitude ?? producer.inventory_latitude %>, <%= item.inventory_longitude ?? producer.inventory_longitude %></div>
                                    <div class="sub">Destination: <%= item.destination_latitude ?? 'â€”' %>, <%= item.destination_longitude ?? 'â€”' %></div>
                                </div>
                                <div>
                                    <% if (item.available_quantity && item.available_quantity > 0) { %>
                                        <div class="badge avail">Available</div>
                                    <% } else { %>
                                        <div class="badge out">Out</div>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <script>
        const inventoryData = <%- JSON.stringify(inventory || []) %>;
        const producerCoords = [parseFloat('<%= producer.inventory_latitude %>') || 11.1271, parseFloat('<%= producer.inventory_longitude %>') || 78.6569];
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        // destination map
        const destLatInput = document.getElementById('destination_lat');
        const destLngInput = document.getElementById('destination_lng');
        const initLat = parseFloat(destLatInput.value) || producerCoords[0];
        const initLng = parseFloat(destLngInput.value) || producerCoords[1];

        const map = L.map('destinationMap').setView([initLat, initLng], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        let destMarker = null;
        if (destLatInput.value && destLngInput.value) {
            destMarker = L.marker([initLat, initLng]).addTo(map);
            destMarker.bindPopup(`Destination<br>Lat: ${initLat}<br>Lng: ${initLng}`);
        }

        map.on('click', function(e){
            const lat = e.latlng.lat.toFixed(7);
            const lng = e.latlng.lng.toFixed(7);
            destLatInput.value = lat; destLngInput.value = lng;
            if (destMarker) destMarker.setLatLng(e.latlng);
            else destMarker = L.marker(e.latlng).addTo(map);
            destMarker.bindPopup(`Destination<br>Lat: ${lat}<br>Lng: ${lng}`).openPopup();
        });

        // plot inventory items on map and list interactions
        const itemMarkers = [];
        const bounds = [];
        let routeControl = null; let fallbackLine = null;

        function toLatLng(lat, lng){ return [parseFloat(lat), parseFloat(lng)]; }

        inventoryData.forEach((it, i) => {
            const startLat = it.inventory_latitude || producerCoords[0];
            const startLng = it.inventory_longitude || producerCoords[1];
            const destLat = it.destination_latitude; const destLng = it.destination_longitude;
            const start = toLatLng(startLat, startLng);
            const m = L.circleMarker(start, { radius:6, color:'#06b6d4', fillColor:'#06b6d4', fillOpacity:0.9 }).addTo(map);
            m.bindPopup(`<strong>${it.item_name}</strong><br>Qty: ${it.available_quantity}`);
            itemMarkers.push({ idx:i, start:m, dest: destLat && destLng ? toLatLng(destLat,destLng) : null });
            bounds.push(start);
            if (destLat && destLng) bounds.push([parseFloat(destLat), parseFloat(destLng)]);
        });

        if (bounds.length) map.fitBounds(bounds, { padding:[30,30] });

        document.querySelectorAll('.item').forEach(card => {
            card.addEventListener('click', () => {
                const idx = parseInt(card.dataset.idx,10);
                const mObj = itemMarkers.find(x=>x.idx===idx);
                if (!mObj) return;
                mObj.start.openPopup && mObj.start.openPopup();
                if (mObj.dest) {
                    // clear old
                    if (routeControl){ try{ map.removeControl(routeControl); }catch(e){} routeControl=null; }
                    if (fallbackLine){ try{ map.removeLayer(fallbackLine); }catch(e){} fallbackLine=null; }

                    // try routing with OSRM
                    const startLatLng = mObj.start.getLatLng();
                    const destLatLng = mObj.dest;
                    
                    console.log('ðŸ—ºï¸ Inventory Route waypoints:', {
                        start: [startLatLng.lat, startLatLng.lng],
                        dest: destLatLng
                    });
                    
                    if (L.Routing && L.Routing.OSRMv1) {
                        try{
                            routeControl = L.Routing.control({
                                waypoints: [ L.latLng(startLatLng), L.latLng(destLatLng[0], destLatLng[1]) ],
                                routeWhileDragging: false,
                                addWaypoints: false,
                                draggableWaypoints: false,
                                fitSelectedRoutes: true,
                                showAlternatives: false,
                                router: new L.Routing.OSRMv1({
                                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                                    profile: 'car',
                                    timeout: 30000,
                                    useHints: false
                                }),
                                lineOptions: { 
                                    styles: [{ color:'#3b82f6', weight:5, opacity: 0.8 }],
                                    extendToWaypoints: true,
                                    missingRouteTolerance: 100
                                },
                                createMarker: ()=>null,
                                show: false,
                                collapsible: false,
                                plan: L.Routing.plan([ L.latLng(startLatLng), L.latLng(destLatLng[0], destLatLng[1]) ], {
                                    createMarker: ()=>null,
                                    addWaypoints: false,
                                    draggableWaypoints: false
                                })
                            }).addTo(map);
                            
                            // Set timeout fallback
                            const routeTimeout = setTimeout(() => {
                                console.warn('âš ï¸ OSRM routing timeout - using fallback');
                                if (routeControl) {
                                    try { map.removeControl(routeControl); } catch(e){}
                                    routeControl = null;
                                }
                                fallbackLine = L.polyline([ startLatLng, destLatLng ], { 
                                    color:'#3b82f6', 
                                    weight:4, 
                                    dashArray:'6,6',
                                    opacity: 0.8 
                                }).addTo(map);
                                map.fitBounds([ startLatLng, destLatLng ], { padding:[30,30] });
                            }, 15000);
                            
                            // Clear timeout if routing succeeds
                            routeControl.on('routesfound', function() {
                                clearTimeout(routeTimeout);
                                console.log('âœ… OSRM route found successfully');
                            });
                            
                            routeControl.on('routingerror', function(e) {
                                clearTimeout(routeTimeout);
                                console.error('âš ï¸ OSRM routing error:', e);
                                // Use fallback
                                if (routeControl) {
                                    try { map.removeControl(routeControl); } catch(e){}
                                    routeControl = null;
                                }
                                fallbackLine = L.polyline([ startLatLng, destLatLng ], { 
                                    color:'#3b82f6', 
                                    weight:4, 
                                    dashArray:'6,6',
                                    opacity: 0.8 
                                }).addTo(map);
                                map.fitBounds([ startLatLng, destLatLng ], { padding:[30,30] });
                            });
                        } catch(e){
                            console.error('âš ï¸ OSRM initialization error:', e);
                            // fallback
                            fallbackLine = L.polyline([ startLatLng, destLatLng ], { 
                                color:'#3b82f6', 
                                weight:4, 
                                dashArray:'6,6',
                                opacity: 0.8 
                            }).addTo(map);
                            map.fitBounds([ startLatLng, destLatLng ], { padding:[30,30] });
                        }
                    } else {
                        console.warn('âš ï¸ Leaflet Routing Machine not available');
                        // fallback if routing lib not loaded
                        fallbackLine = L.polyline([ startLatLng, destLatLng ], { 
                            color:'#3b82f6', 
                            weight:4, 
                            dashArray:'6,6',
                            opacity: 0.8 
                        }).addTo(map);
                        map.fitBounds([ startLatLng, destLatLng ], { padding:[30,30] });
                    }
                } else {
                    map.panTo(mObj.start.getLatLng(), { animate:true, duration:0.6 });
                }

                if (!prefersReducedMotion) gsap.fromTo(card, { scale:0.99 }, { scale:1, duration:0.35, ease:'sine.out' });
            });
        });

        if (!prefersReducedMotion) {
            gsap.from('.title', { opacity:0, y:18, duration:0.8, ease:'power3.out' });
            gsap.from('.panel', { opacity:0, y:26, duration:0.9, stagger:0.08 });
            gsap.utils.toArray('.item').forEach((el,i)=> gsap.from(el, { opacity:0, y:8, duration:0.6, delay:i*0.03 }));
        }
    </script>
</body>
</html>