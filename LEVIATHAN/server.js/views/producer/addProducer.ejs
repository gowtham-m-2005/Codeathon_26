<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Producer</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root { --panel-bg: rgba(255,255,255,0.03); --muted: #94a3b8; }
        body { font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(180deg,#0a0e27,#111427); color: #e6eef8; margin:0; }
        .page-wrap { max-width:1200px; margin: 40px auto 120px; padding: 20px; }

        .add-header { display:flex; align-items:center; gap:20px; margin-bottom:24px; }
        .add-title { font-size:28px; font-weight:800; letter-spacing:-0.5px; }
        .add-desc { color:var(--muted); font-size:14px; }

        .form-grid { display:grid; grid-template-columns: 1fr 520px; gap:32px; align-items:start; }
        .panel { background: var(--panel-bg); border:1px solid rgba(255,255,255,0.06); padding:24px; border-radius:12px; }

        form label { display:block; font-weight:600; margin-bottom:8px; color:#cfe3ff; }
        form input[type="text"], form input[type="email"], form input[type="tel"] { width:100%; padding:12px 14px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; margin-bottom:16px; }

        #map { height: 480px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); }

        .help { color:var(--muted); font-size:13px; margin-bottom:12px; }

        .controls { display:flex; gap:12px; align-items:center; margin-top:8px; }
        #submitBtn { padding:12px 20px; background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer; box-shadow: 0 12px 40px rgba(59,130,246,0.18); }
        #submitBtn[disabled] { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }

        .meta { color:var(--muted); font-size:13px; }

        /* small visuals */
        .visual-row { display:flex; gap:12px; margin-top:10px; }
        .visual-badge { background: linear-gradient(135deg,#10b981,#3b82f6); padding:8px 12px; border-radius:10px; font-weight:700; }

        @media (max-width: 980px) { .form-grid { grid-template-columns: 1fr; } #map { height: 360px; } }

        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; animation: none !important; }
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="page-wrap">
        <div class="add-header">
            <div>
                <div class="add-title">Add Producer</div>
                <div class="add-desc">Create a producer and pin its inventory location. The system will use this for smart routing and blockchain tracking.</div>
            </div>
            <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
                <div class="visual-badge">üì¶ Packages</div>
                <div class="visual-badge">üöö Containers</div>
                <div class="visual-badge">‚õìÔ∏è Traceable</div>
            </div>
        </div>

        <div class="form-grid">
            <div class="panel">
                <form action="/producer/register" method="POST" id="producerForm">
                    <label for="producer_name">Producer Name</label>
                    <input id="producer_name" type="text" name="producer_name" required placeholder="e.g., WeGrow Farms">

                    <label for="email">Email</label>
                    <input id="email" type="email" name="email" required placeholder="contact@producer.example">

                    <label for="phone">Phone</label>
                    <input id="phone" type="tel" name="phone" required placeholder="+91 98765 43210">

                    <div class="help">Select the producer inventory location on the map to enable registration.</div>

                    <!-- Hidden fields populated from map -->
                    <input type="hidden" name="inventory_latitude" id="lat" required>
                    <input type="hidden" name="inventory_longitude" id="lng" required>

                    <div class="controls">
                        <button type="submit" id="submitBtn" disabled>Add Producer</button>
                        <div class="meta" id="locationMeta">No location selected</div>
                    </div>
                </form>
            </div>

            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div style="font-weight:700;">Select Inventory Location</div>
                    <div class="meta">Click on the map to set coordinates</div>
                </div>
                <div id="map"></div>
                <div class="visual-row">
                    <div class="meta">Latitude: <span id="latView">‚Äî</span></div>
                    <div class="meta">Longitude: <span id="lngView">‚Äî</span></div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <script>
        gsap.registerPlugin(ScrollTrigger);
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        // Init map centered on Tamil Nadu
        const map = L.map('map', { zoomControl: false }).setView([11.1271, 78.6569], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        let marker;
        const submitBtn = document.getElementById('submitBtn');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');
        const latView = document.getElementById('latView');
        const lngView = document.getElementById('lngView');
        const locationMeta = document.getElementById('locationMeta');

        function enableSubmit(lat, lng) {
            latInput.value = lat;
            lngInput.value = lng;
            latView.textContent = lat;
            lngView.textContent = lng;
            locationMeta.textContent = `Selected: ${lat}, ${lng}`;
            submitBtn.disabled = false;

            if (!prefersReducedMotion) {
                gsap.fromTo('#submitBtn', { scale: 0.96 }, { scale:1.02, duration:0.4, repeat:1, yoyo:true, ease:'sine.inOut' });
                gsap.fromTo('#map', { y: -6 }, { y:0, duration:0.6, ease:'power2.out' });
            }
        }

        map.on('click', function(e) {
            const lat = e.latlng.lat.toFixed(7);
            const lng = e.latlng.lng.toFixed(7);

            if (marker) { marker.setLatLng(e.latlng); }
            else { marker = L.marker(e.latlng).addTo(map); }

            marker.bindPopup(`Inventory Location<br>Lat: ${lat}<br>Lng: ${lng}`).openPopup();

            enableSubmit(lat, lng);

            // Small marker bounce (animate icon element if available)
            if (!prefersReducedMotion) {
                const markerEl = marker.getElement && marker.getElement();
                if (markerEl) gsap.fromTo(markerEl, { y:-10 }, { y:0, duration:0.6, ease:'bounce.out' });
            }
        });

        // GSAP entrance animations for form and map
        if (!prefersReducedMotion) {
            gsap.from('.add-title', { opacity:0, y:20, duration:0.8, ease:'power3.out' });
            gsap.from('.add-desc', { opacity:0, y:12, duration:0.8, delay:0.1 });
            gsap.from('.panel', { opacity:0, y:30, duration:0.9, stagger:0.12, ease:'power3.out' });
            gsap.from('.hero-icon, .visual-badge', { opacity:0, scale:0.9, stagger:0.08, duration:0.6, ease:'back.out(1.2)' });

            // subtle floating of map panel
            gsap.to('#map', { y: -6, duration:6, repeat:-1, yoyo:true, ease:'sine.inOut' });
        }

        // Simple client-side form validation animation: shake if submit clicked when disabled
        document.getElementById('producerForm').addEventListener('submit', function(e){
            if (submitBtn.disabled) {
                e.preventDefault();
                if (!prefersReducedMotion) gsap.fromTo('.panel', { x:-6 }, { x:0, duration:0.4, ease:'elastic.out(1,0.6)' });
                alert('Please select a location on the map before submitting.');
            }
        });
    </script>
</body>
</html>
