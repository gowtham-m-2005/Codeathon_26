<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Container Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;}
    body{font-family: Inter,Segoe UI,Roboto,Arial,Helvetica,sans-serif; margin:0; padding:20px; background:linear-gradient(180deg,#071021 0%, #0b1320 100%); color:#e6eef6}
    .container {max-width:1100px; margin:0 auto;}
    h1{margin:0 0 14px 0; font-weight:600; letter-spacing:0.4px}
    .dashboard-grid{display:grid; grid-template-columns: 360px 1fr; gap:18px; align-items:start}
    .card{background:var(--card); border-radius:10px; padding:16px; box-shadow: 0 6px 20px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    #map{height:420px; border-radius:8px; overflow:hidden}
    .info .meta-table{width:100%; border-collapse:collapse}
    .meta-table th{width:42%; text-align:left; padding:8px; color:var(--muted); font-weight:600}
    .meta-table td{padding:8px; color:#dff0ff}
    .actions{display:flex; gap:8px; margin-top:12px}
    .btn{background:linear-gradient(90deg,var(--accent),#7c3aed); color:#042027; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted)}
    .analytics{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .chart-card{background:var(--glass); padding:12px; border-radius:8px; min-height:120px; display:flex; flex-direction:column; justify-content:center; align-items:center}
    .chart-card h4{margin:0 0 8px 0; font-size:13px; color:var(--muted)}
    @media (max-width:980px){.dashboard-grid{grid-template-columns:1fr;}.info{order:2}}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <!-- Chart.js removed to simplify view and ensure map renders cleanly -->
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container">
    <h1>Container Dashboard</h1>
    <div class="dashboard-grid">
      <div class="card info" id="infoCard">
        <table class="meta-table">
          <tbody>
            <tr><th>ID</th><td><%= container.container_id %></td></tr>
            <tr><th>Code</th><td><%= container.container_code || '' %></td></tr>
            <tr><th>Driver</th><td><%= container.driver_name || '' %></td></tr>
            <tr><th>Driver Phone</th><td><a style="color:inherit" href="tel:<%= container.driver_phone||'' %>"><%= container.driver_phone || '' %></a></td></tr>
            <tr><th>Available / Total</th><td><strong><%= container.available_sections %></strong> / <%= container.total_sections %></td></tr>
            <tr><th>Cost / Section</th><td>₹<%= container.cost_per_section %></td></tr>
            <tr><th>Section Size</th><td><%= container.section_storage_space || '' %></td></tr>
            <tr><th>Location (lat,lng)</th><td><%= container.current_latitude %>, <%= container.current_longitude %></td></tr>
            <tr><th>Last Updated</th><td><%= container.last_updated || '—' %></td></tr>
          </tbody>
        </table>
        <div class="actions">
          <a class="btn" id="centerMapBtn">Center Map</a>
          <a class="btn ghost" href="/container/<%= container.container_id %>/routing">Open Routing Dashboard</a>
        </div>
      </div>

      <div class="card right" id="mapCard">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const c = <%- JSON.stringify(container || {}) %>;

    // Map setup
    const map = L.map('map', {zoomControl:true, attributionControl:false});
    const lat = parseFloat(c.current_latitude);
    const lng = parseFloat(c.current_longitude);
    if (!isNaN(lat) && !isNaN(lng)) map.setView([lat, lng], 12);
    else map.setView([20.5937, 78.9629], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let marker = null;
    if (!isNaN(lat) && !isNaN(lng)) {
      marker = L.circleMarker([lat, lng], {radius:10, color:'#06b6d4', fillColor:'#06b6d4', fillOpacity:0.9}).addTo(map);
      marker.bindPopup(`<strong>${c.container_code || 'Container'}</strong><br/>Driver: ${c.driver_name || ''}`);
      marker.openPopup();
    }

    // GSAP entrance animations (simplified)
    gsap.from('#infoCard', {x:-24, autoAlpha:0, duration:0.6, ease:'power3.out'});
    gsap.from('#mapCard', {x:24, autoAlpha:0, duration:0.6, ease:'power3.out', delay:0.08});

    // Center map button
    const centerBtn = document.getElementById('centerMapBtn');
    centerBtn.addEventListener('click', ()=>{
      if (!isNaN(lat) && !isNaN(lng)) {
        map.flyTo([lat,lng], 14, {duration:0.9});
        if (marker && marker.openPopup) marker.openPopup();
        gsap.fromTo('#map', {scale:0.997}, {scale:1, duration:0.6, ease:'elastic.out(1,0.6)'});
      }
    });

    // Ensure Leaflet draws after layout — call whenReady and a slightly longer timeout
    map.whenReady(()=> setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 500));
  </script>
  <%- include('../partials/footer') %>
</body>
</html>
